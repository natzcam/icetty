#!/usr/bin/env node

const debug = require("debug")("icettyd");
const { spawn } = require("node-pty");
const peer = require("../lib/peer/clipboard");
const os = require("os");

peer.start(p => {
  let pty;
  try {
    pty = spawn(os.platform() === "win32" ? "powershell.exe" : "bash", [], {
      name: "icetty",
      cols: 80,
      rows: 30,
      cwd: process.env.HOME,
      env: process.env
    });
  } catch (err) {
    p.destroy(err);
  }

  if (pty) {
    pty.on("data", data => {
      p.send(data);
    });

    pty.on("exit", () => {
      p.destroy(new Error("Process exited."));
    });

    p.on("data", data => {
      pty.write(data);
    });

    p.on("error", err => {
      debug(err);
    });

    p.on("close", () => {
      debug("Remote peer connection closed.");
      pty.kill();
    });
  }
});
